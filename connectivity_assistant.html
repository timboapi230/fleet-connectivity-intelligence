<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>Connectivity Assistant</title>
<link href='https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap' rel='stylesheet'>
</head>
<body style='margin:0;padding:0;font-family:"Roboto",sans-serif;background:#F4F6F8;height:100vh;display:flex;flex-direction:column;'>

<div style='background:#1A2B3C;color:#FFF;padding:15px 20px;display:flex;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);'>
  <div style='background:#00893E;width:10px;height:10px;border-radius:50%;margin-right:10px;'></div>
  <h2 style='margin:0;font-size:18px;font-weight:500;'>Connectivity Assistant</h2>
</div>

<div id='ca-chat-window' style='flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;'></div>

<div style='background:#FFF;padding:15px;border-top:1px solid #DDE2E6;display:flex;gap:10px;'>
  <input id='ca-user-input' type='text' placeholder='Ask about vehicles, carriers, or issues...' style='flex:1;padding:12px;border:1px solid #CCC;border-radius:4px;outline:none;font-size:14px;'>
  <button id='ca-send-btn' style='background:#00893E;color:#FFF;border:none;padding:0 25px;border-radius:4px;cursor:pointer;font-weight:bold;'>SEND</button>
</div>

<script>
var FLEET=[
{nm:"Demo - 01",lat:41.897522,lon:-8.85737,sig:80,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000001",imei:"35684900000191",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:205,plan:2048,drops:1,uptime:99.2,errCount:0,errTypes:[]},
{nm:"Demo - 02",lat:41.8975754,lon:-8.85745,sig:88,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000002",imei:"35684900000223",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:274,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 03",lat:41.8975754,lon:-8.85745,sig:92,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000003",imei:"35684900000339",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:158,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 04",lat:41.9144211,lon:-8.84741,sig:85,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000004",imei:"35684900000485",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:338,plan:2048,drops:1,uptime:98.5,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 05",lat:42.0410385,lon:-8.64806,sig:98,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000005",imei:"35684900000537",mcc:"268",mnc:"01",lac:"131",cell:"47723",used:272,plan:2048,drops:1,uptime:98.7,errCount:0,errTypes:[]},
{nm:"Demo - 06",lat:41.912014,lon:-8.85141,sig:76,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000006",imei:"35684900000654",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:256,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 07",lat:41.8974724,lon:-8.8574,sig:75,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000007",imei:"35684900000758",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:163,plan:2048,drops:1,uptime:99.1,errCount:0,errTypes:[]},
{nm:"Demo - 08",lat:42.1180687,lon:-8.81293,sig:88,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000008",imei:"35684900000815",mcc:"268",mnc:"01",lac:"131",cell:"47723",used:344,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 09",lat:41.8974724,lon:-8.85745,sig:104,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000009",imei:"35684900000968",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:237,plan:2048,drops:1,uptime:98.1,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 10",lat:41.8974724,lon:-8.85745,sig:92,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000010",imei:"35684900001044",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:146,plan:2048,drops:1,uptime:99.0,errCount:0,errTypes:[]},
{nm:"Demo - 11",lat:41.8974724,lon:-8.85778,sig:69,tier:"minor",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000011",imei:"35684900001144",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:438,plan:2048,drops:3,uptime:96.7,errCount:2,errTypes:["CONTEXT_DEACTIVATION","NETWORK_TIMEOUT"]},
{nm:"Demo - 12",lat:41.8974724,lon:-8.85778,sig:76,tier:"minor",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000012",imei:"35684900001261",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:214,plan:2048,drops:2,uptime:96.3,errCount:3,errTypes:["NETWORK_TIMEOUT"]},
{nm:"Demo - 13",lat:42.2348289,lon:-8.71309,sig:75,tier:"minor",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000013",imei:"35684900001368",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:371,plan:2048,drops:2,uptime:96.8,errCount:5,errTypes:["NETWORK_TIMEOUT","CONTEXT_DEACTIVATION"]},
{nm:"Demo - 14",lat:41.897522,lon:-8.8577,sig:65,tier:"minor",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000014",imei:"35684900001427",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:208,plan:2048,drops:1,uptime:99.4,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 15",lat:42.1971474,lon:-8.65275,sig:69,tier:"minor",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000015",imei:"35684900001564",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:281,plan:2048,drops:2,uptime:97.9,errCount:5,errTypes:["NETWORK_TIMEOUT","CONTEXT_DEACTIVATION"]},
{nm:"Demo - 16",lat:42.2594833,lon:-8.45926,sig:82,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000016",imei:"35684900001678",mcc:"268",mnc:"03",lac:"234",cell:"18145",used:125,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 17",lat:42.1242371,lon:-8.79762,sig:88,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000017",imei:"35684900001768",mcc:"268",mnc:"01",lac:"131",cell:"47723",used:169,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 18",lat:42.2643967,lon:-8.45686,sig:99,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000018",imei:"35684900001848",mcc:"268",mnc:"03",lac:"234",cell:"18145",used:313,plan:2048,drops:1,uptime:99.5,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 19",lat:42.2643967,lon:-8.45686,sig:102,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000019",imei:"35684900001979",mcc:"268",mnc:"03",lac:"234",cell:"18145",used:128,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 20",lat:42.2643967,lon:-8.45686,sig:95,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000020",imei:"35684900002056",mcc:"268",mnc:"03",lac:"234",cell:"18145",used:212,plan:2048,drops:1,uptime:99.4,errCount:0,errTypes:[]},
{nm:"Demo - 21",lat:41.5282936,lon:0.51638,sig:89,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000021",imei:"35684900002172",mcc:"268",mnc:"03",lac:"354",cell:"12245",used:271,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 22",lat:41.0981636,lon:1.09873,sig:83,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000022",imei:"35684900002231",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:239,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 23",lat:39.8665466,lon:-0.12219,sig:104,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000023",imei:"35684900002361",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:264,plan:2048,drops:1,uptime:98.7,errCount:0,errTypes:[]},
{nm:"Demo - 24",lat:38.9980164,lon:-0.55747,sig:103,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000024",imei:"35684900002418",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:204,plan:2048,drops:1,uptime:98.8,errCount:0,errTypes:[]},
{nm:"Demo - 25",lat:41.5282936,lon:0.51638,sig:86,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000025",imei:"35684900002590",mcc:"268",mnc:"03",lac:"354",cell:"12245",used:120,plan:2048,drops:1,uptime:98.5,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 26",lat:41.8975487,lon:-8.85773,sig:104,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000026",imei:"35684900002640",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:180,plan:2048,drops:1,uptime:98.2,errCount:0,errTypes:[]},
{nm:"Demo - 27",lat:41.897522,lon:-8.85775,sig:84,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000027",imei:"35684900002783",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:264,plan:2048,drops:1,uptime:98.9,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 28",lat:41.897522,lon:-8.85768,sig:102,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000028",imei:"35684900002822",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:249,plan:2048,drops:1,uptime:98.8,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 29",lat:42.2348557,lon:-8.71327,sig:85,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000029",imei:"35684900002916",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:335,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 30",lat:41.8975487,lon:-8.85773,sig:99,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000030",imei:"35684900003023",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:308,plan:2048,drops:1,uptime:98.3,errCount:0,errTypes:[]},
{nm:"Demo - 31",lat:42.1336327,lon:-8.79844,sig:37,tier:"critical",rat:"GSM",carrier:"Orange ES",country:"Spain",imsi:"214010000000031",imei:"35684900003145",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:1296,plan:2048,drops:11,uptime:93.3,errCount:40,errTypes:["AUTH_FAILURE","GPRS_DETACH","NETWORK_TIMEOUT","CONTEXT_DEACTIVATION","ATTACH_REJECT"]},
{nm:"Demo - 32",lat:42.1608696,lon:-8.7636,sig:26,tier:"critical",rat:"WCDMA",carrier:"Orange ES",country:"Spain",imsi:"214010000000032",imei:"35684900003237",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:1277,plan:2048,drops:18,uptime:90.6,errCount:27,errTypes:["CONTEXT_DEACTIVATION","ATTACH_REJECT","GPRS_DETACH"]},
{nm:"Demo - 33",lat:42.1335793,lon:-8.79834,sig:29,tier:"critical",rat:"GSM",carrier:"Orange ES",country:"Spain",imsi:"214010000000033",imei:"35684900003381",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:971,plan:2048,drops:9,uptime:90.9,errCount:21,errTypes:["NETWORK_TIMEOUT","GPRS_DETACH","AUTH_FAILURE"]},
{nm:"Demo - 34",lat:42.1335297,lon:-8.79813,sig:41,tier:"critical",rat:"WCDMA",carrier:"Orange ES",country:"Spain",imsi:"214010000000034",imei:"35684900003471",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:821,plan:2048,drops:13,uptime:85,errCount:16,errTypes:["AUTH_FAILURE","PDP_REJECT","GPRS_DETACH","ATTACH_REJECT","CONTEXT_DEACTIVATION"]},
{nm:"Demo - 35",lat:42.1335793,lon:-8.79821,sig:32,tier:"critical",rat:"WCDMA",carrier:"Orange ES",country:"Spain",imsi:"214010000000035",imei:"35684900003582",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:978,plan:2048,drops:17,uptime:85,errCount:34,errTypes:["CONTEXT_DEACTIVATION","NETWORK_TIMEOUT","ATTACH_REJECT"]},
{nm:"Demo - 36",lat:39.4852333,lon:-0.5346,sig:63,tier:"warning",rat:"WCDMA",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000036",imei:"35684900003650",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:599,plan:2048,drops:4,uptime:96.2,errCount:15,errTypes:["GPRS_DETACH","CONTEXT_DEACTIVATION","PDP_REJECT"]},
{nm:"Demo - 37",lat:39.4852333,lon:-0.5346,sig:65,tier:"warning",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000037",imei:"35684900003782",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:485,plan:2048,drops:7,uptime:90.8,errCount:13,errTypes:["CONTEXT_DEACTIVATION","GPRS_DETACH","PDP_REJECT"]},
{nm:"Demo - 38",lat:39.485363,lon:-0.53524,sig:67,tier:"warning",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000038",imei:"35684900003866",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:786,plan:2048,drops:3,uptime:96.6,errCount:15,errTypes:["PDP_REJECT","GPRS_DETACH","CONTEXT_DEACTIVATION"]},
{nm:"Demo - 39",lat:38.6321678,lon:-3.46614,sig:66,tier:"warning",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000039",imei:"35684900003980",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:425,plan:2048,drops:3,uptime:95.4,errCount:10,errTypes:["NETWORK_TIMEOUT","GPRS_DETACH"]},
{nm:"Demo - 40",lat:39.4852333,lon:-0.5346,sig:60,tier:"warning",rat:"WCDMA",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000040",imei:"35684900004016",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:766,plan:2048,drops:5,uptime:92.8,errCount:5,errTypes:["CONTEXT_DEACTIVATION","NETWORK_TIMEOUT","GPRS_DETACH"]},
{nm:"Demo - 41",lat:41.8974724,lon:-8.8577,sig:103,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000041",imei:"35684900004164",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:119,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 42",lat:41.8974724,lon:-8.8577,sig:82,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000042",imei:"35684900004257",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:299,plan:2048,drops:1,uptime:99.4,errCount:0,errTypes:[]},
{nm:"Demo - 43",lat:42.2350349,lon:-8.7135,sig:94,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000043",imei:"35684900004356",mcc:"214",mnc:"03",lac:"803",cell:"64084",used:281,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 44",lat:41.9005966,lon:-8.86254,sig:105,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000044",imei:"35684900004481",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:231,plan:2048,drops:1,uptime:98.2,errCount:0,errTypes:[]},
{nm:"Demo - 45",lat:41.9296761,lon:-8.83712,sig:102,tier:"healthy",rat:"LTE",carrier:"Orange ES",country:"Spain",imsi:"214010000000045",imei:"35684900004532",mcc:"214",mnc:"03",lac:"103",cell:"49885",used:312,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 46",lat:39.4852867,lon:-0.53537,sig:77,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000046",imei:"35684900004641",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:193,plan:2048,drops:1,uptime:99.4,errCount:0,errTypes:[]},
{nm:"Demo - 47",lat:39.4852867,lon:-0.53537,sig:101,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000047",imei:"35684900004738",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:106,plan:2048,drops:1,uptime:98.8,errCount:0,errTypes:[]},
{nm:"Demo - 48",lat:40.1711884,lon:-0.86172,sig:83,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000048",imei:"35684900004894",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:253,plan:2048,drops:0,uptime:100.0,errCount:0,errTypes:[]},
{nm:"Demo - 49",lat:41.7350159,lon:-1.20484,sig:102,tier:"healthy",rat:"LTE",carrier:"NOS PT",country:"Portugal",imsi:"214010000000049",imei:"35684900004945",mcc:"268",mnc:"03",lac:"354",cell:"12245",used:112,plan:2048,drops:0,uptime:100.0,errCount:1,errTypes:["CONTEXT_DEACTIVATION"]},
{nm:"Demo - 50",lat:39.4860535,lon:-0.53507,sig:88,tier:"healthy",rat:"LTE",carrier:"Vodafone PT",country:"Portugal",imsi:"214010000000050",imei:"35684900005024",mcc:"268",mnc:"01",lac:"954",cell:"49145",used:240,plan:2048,drops:1,uptime:99.1,errCount:0,errTypes:[]}
];

function addMessage(text, isUser, html) {
  var win = document.getElementById('ca-chat-window');
  var msg = document.createElement('div');
  msg.style.maxWidth = '80%';
  msg.style.padding = '12px 16px';
  msg.style.borderRadius = '10px';
  msg.style.fontSize = '14px';
  msg.style.lineHeight = '1.5';
  if (isUser) {
    msg.style.alignSelf = 'flex-end';
    msg.style.background = '#00893E';
    msg.style.color = '#FFF';
    msg.textContent = text;
  } else {
    msg.style.alignSelf = 'flex-start';
    msg.style.background = '#FFF';
    msg.style.color = '#333';
    msg.style.border = '1px solid #DDE2E6';
    if (html) { msg.innerHTML = html; } else { msg.textContent = text; }
  }
  win.appendChild(msg);
  win.scrollTop = win.scrollHeight;
}

function getTierColor(tier) {
  switch(tier) {
    case 'critical': return '#e74c3c';
    case 'warning': return '#f39c12';
    case 'minor': return '#3498db';
    default: return '#00893E';
  }
}

function formatVehicleCard(v) {
  var color = getTierColor(v.tier);
  var usagePct = Math.round(v.used / v.plan * 100);
  var errList = v.errTypes.length > 0 ? '<div style="margin-top:6px;font-size:11px;color:#e74c3c;">Errors: ' + v.errTypes.join(', ') + '</div>' : '';
  return '<div style="border-left:5px solid ' + color + ';padding-left:10px;">' +
    '<div style="font-weight:bold;font-size:16px;color:#1A2B3C;margin-bottom:5px;">' + v.nm +
    ' <span style="font-size:10px;text-transform:uppercase;background:' + color + ';color:#FFF;padding:2px 6px;border-radius:10px;vertical-align:middle;margin-left:5px;">' + v.tier + '</span></div>' +
    '<div style="font-size:12px;color:#666;"><b>' + v.carrier + '</b> (' + v.rat + ') - ' + v.country + '</div>' +
    '<div style="margin:8px 0;font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:5px;">' +
    '<div>Signal: ' + v.sig + ' dBm</div>' +
    '<div>Uptime: ' + v.uptime + '%</div>' +
    '<div>Drops: ' + v.drops + '</div>' +
    '<div>Errors: ' + v.errCount + '</div>' +
    '</div>' +
    '<div style="font-family:monospace;font-size:11px;background:#F8F9FA;padding:5px;border-radius:4px;">' +
    'IMSI: ' + v.imsi + '<br>IMEI: ' + v.imei + '<br>Cell: ' + v.mcc + '-' + v.mnc + '-' + v.lac + '-' + v.cell + '</div>' +
    '<div style="margin-top:8px;font-size:11px;">Data: ' + v.used + 'MB / ' + v.plan + 'MB (' + usagePct + '%)</div>' +
    errList +
    '</div>';
}

function processInput() {
  var input = document.getElementById('ca-user-input');
  var text = input.value.trim();
  if (!text) return;
  addMessage(text, true);
  var query = text.toLowerCase();
  input.value = '';

  setTimeout(function() {
    var results = [];
    var html = '';

    // Fleet summary
    if (query.indexOf('status') > -1 || query.indexOf('summary') > -1 || (query.indexOf('fleet') > -1 && query.indexOf('overview') === -1 && query.length < 20)) {
      var crit = FLEET.filter(function(v) { return v.tier === 'critical'; }).length;
      var warn = FLEET.filter(function(v) { return v.tier === 'warning'; }).length;
      var minor = FLEET.filter(function(v) { return v.tier === 'minor'; }).length;
      var healthy = FLEET.filter(function(v) { return v.tier === 'healthy'; }).length;
      var totalErr = FLEET.reduce(function(s, v) { return s + v.errCount; }, 0);
      var totalDrops = FLEET.reduce(function(s, v) { return s + v.drops; }, 0);
      var lte = FLEET.filter(function(v) { return v.rat === 'LTE'; }).length;
      html = '<b style="font-size:16px;">Fleet Summary</b><br><br>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">' +
        '<div>Total Vehicles: <b>' + FLEET.length + '</b></div>' +
        '<div>LTE Coverage: <b>' + Math.round(lte/FLEET.length*100) + '%</b></div>' +
        '<div style="color:#e74c3c;">Critical: <b>' + crit + '</b></div>' +
        '<div style="color:#f39c12;">Warning: <b>' + warn + '</b></div>' +
        '<div style="color:#3498db;">Minor: <b>' + minor + '</b></div>' +
        '<div style="color:#00893E;">Healthy: <b>' + healthy + '</b></div>' +
        '<div>Total Errors: <b>' + totalErr + '</b></div>' +
        '<div>Total Drops: <b>' + totalDrops + '</b></div>' +
        '</div>';
      addMessage(null, false, html);
      return;
    }

    // Error summary
    if (query.indexOf('error') > -1 && (query.indexOf('how many') > -1 || query.indexOf('count') > -1 || query.indexOf('total') > -1 || query.indexOf('type') > -1 || query.indexOf('summary') > -1)) {
      var totalErr = FLEET.reduce(function(s, v) { return s + v.errCount; }, 0);
      var errMap = {};
      FLEET.forEach(function(v) { v.errTypes.forEach(function(e) { errMap[e] = (errMap[e] || 0) + 1; }); });
      var errHtml = '';
      Object.keys(errMap).sort(function(a,b) { return errMap[b] - errMap[a]; }).forEach(function(k) {
        errHtml += '<div>' + k + ': <b>' + errMap[k] + '</b> occurrences</div>';
      });
      html = '<b>Network Error Summary</b><br>Total errors across fleet: <b>' + totalErr + '</b><br><br>' + errHtml;
      addMessage(null, false, html);
      return;
    }

    // Help
    if (query.indexOf('help') > -1) {
      html = '<b>Things you can ask:</b><br><br>' +
        '\u2022 <b>show critical vehicles</b> \u2014 vehicles needing immediate attention<br>' +
        '\u2022 <b>show warning vehicles</b> \u2014 vehicles with degraded connectivity<br>' +
        '\u2022 <b>Demo-31</b> or any vehicle name \u2014 look up a specific vehicle<br>' +
        '\u2022 <b>Spain</b> or <b>Portugal</b> \u2014 filter by country<br>' +
        '\u2022 <b>Orange ES</b> or <b>Vodafone PT</b> \u2014 filter by carrier<br>' +
        '\u2022 <b>2G</b> / <b>GSM</b> / <b>WCDMA</b> / <b>LTE</b> \u2014 filter by radio technology<br>' +
        '\u2022 <b>214010000000031</b> \u2014 look up by IMSI<br>' +
        '\u2022 <b>35684900003145</b> \u2014 look up by IMEI<br>' +
        '\u2022 <b>how many errors</b> \u2014 error count and breakdown<br>' +
        '\u2022 <b>fleet summary</b> \u2014 overall fleet health';
      addMessage(null, false, html);
      return;
    }

    // Tier filter
    if (query.indexOf('critical') > -1) {
      results = FLEET.filter(function(v) { return v.tier === 'critical'; });
      html = 'Found <b>' + results.length + '</b> critical vehicles:';
    } else if (query.indexOf('warning') > -1) {
      results = FLEET.filter(function(v) { return v.tier === 'warning'; });
      html = 'Found <b>' + results.length + '</b> warning vehicles:';
    } else if (query.indexOf('minor') > -1 && query.indexOf('demo') === -1) {
      results = FLEET.filter(function(v) { return v.tier === 'minor'; });
      html = 'Found <b>' + results.length + '</b> minor vehicles:';
    } else if (query.indexOf('healthy') > -1) {
      results = FLEET.filter(function(v) { return v.tier === 'healthy'; });
      html = 'Found <b>' + results.length + '</b> healthy vehicles:';
    } else {
      // Search across all fields
      results = FLEET.filter(function(v) {
        var q = query.replace(/[\s-]+/g, '');
        var nm = v.nm.toLowerCase().replace(/[\s-]+/g, '');
        return nm.indexOf(q) > -1 ||
          query.indexOf(v.imsi) > -1 ||
          query.indexOf(v.imei) > -1 ||
          query.indexOf(v.carrier.toLowerCase()) > -1 ||
          query.indexOf(v.country.toLowerCase()) > -1 ||
          (query.indexOf('gsm') > -1 && v.rat === 'GSM') ||
          (query.indexOf('2g') > -1 && v.rat === 'GSM') ||
          (query.indexOf('wcdma') > -1 && v.rat === 'WCDMA') ||
          (query.indexOf('3g') > -1 && v.rat === 'WCDMA') ||
          ((query === 'lte' || query.indexOf('show lte') > -1 || query.indexOf('lte vehicle') > -1) && v.rat === 'LTE') ||
          (query.indexOf('4g') > -1 && v.rat === 'LTE');
      });
      if (results.length > 0) {
        html = 'Found <b>' + results.length + '</b> matching vehicles:';
      } else {
        html = "I couldn't find anything matching that. Type <b>help</b> for a list of things you can ask.";
      }
    }

    addMessage(null, false, html);
    results.slice(0, 10).forEach(function(v) {
      addMessage(null, false, formatVehicleCard(v));
    });
    if (results.length > 10) {
      addMessage(null, false, '...and <b>' + (results.length - 10) + '</b> more vehicles matching your query.');
    }
  }, 300);
}

// MyGeotab Add-In lifecycle
if (typeof geotab !== 'undefined') {
  geotab.addin['connectivity-assistant'] = function() {
    return {
      initialize: function(api, state, callback) {
        document.getElementById('ca-send-btn').onclick = processInput;
        document.getElementById('ca-user-input').onkeypress = function(e) { if (e.which === 13) processInput(); };
        addMessage(null, false, "Hi! I'm the <b>Fleet Connectivity Assistant</b>. Ask me about network issues, vehicles, carriers, countries, or paste an IMSI/IMEI to look up.<br><br>Try: <b>show critical vehicles</b> or <b>Demo-31</b> or type <b>help</b>");
        callback();
      },
      focus: function(api, state) {},
      blur: function(api, state) {}
    };
  };
}

// Standalone mode (when opened directly in browser)
window.addEventListener('load', function() {
  if (typeof geotab === 'undefined') {
    document.getElementById('ca-send-btn').onclick = processInput;
    document.getElementById('ca-user-input').onkeypress = function(e) { if (e.which === 13) processInput(); };
    addMessage(null, false, "Hi! I'm the <b>Fleet Connectivity Assistant</b>. Ask me about network issues, vehicles, carriers, countries, or paste an IMSI/IMEI to look up.<br><br>Try: <b>show critical vehicles</b> or <b>Demo-31</b> or type <b>help</b>");
  }
});
</script>
</body>
</html>
